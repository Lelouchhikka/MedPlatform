{% extends "core/base.html" %}
{% block title %}–ú–µ–Ω—ñ“£ –∫–µ—Å—Ç–µ–º{% endblock %}
{% block content %}
<div class="container">
    <h2 class="text-center">–ú–µ–Ω—ñ“£ –∫–µ—Å—Ç–µ–º</h2>
    <input type="hidden" id="doctor-id" value="{{ doctor.id }}">

    <!-- üîç –ö“Ø–Ω–¥—ñ —Ç–∞“£–¥–∞—É -->
    <div class="d-flex justify-content-between">
        <h4>–ö“Ø–Ω–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:</h4>
        <a href="{% url 'create_schedule' %}" class="btn btn-success">‚ûï –ö–µ—Å—Ç–µ “õ–æ—Å—É</a>
    </div>

    <!-- üîÑ –ö“Ø–Ω–¥–µ—Ä–¥—ñ –±–∞—Ç—ã—Ä–º–∞ —Ç“Ø—Ä—ñ–Ω–¥–µ –∫”©—Ä—Å–µ—Ç—É -->
    <div class="date-picker d-flex flex-wrap mt-3">
        {% for date in schedule_dates %}
        <button class="btn btn-outline-primary m-1 date-btn"
                onclick="loadDoctorTimes('{{ date|date:'Y-m-d' }}')"
                data-date="{{ date|date:'Y-m-d' }}">
            {{ date|date:"d F, Y" }}
        </button>
        {% endfor %}
    </div>

    <hr>
    <h4>“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ —É–∞“õ—ã—Ç—Ç–∞—Ä:</h4>
    <p id="error-message" class="text-danger"></p>
    <div id="times-container" class="d-flex flex-wrap"></div>
</div>

<!-- ‚úÖ –î”ô—Ä—ñ–≥–µ—Ä–¥—ñ“£ –∫–µ—Å—Ç–µ—Å—ñ–Ω –∂“Ø–∫—Ç–µ—É “Ø—à—ñ–Ω JavaScript -->
<script>
function deleteSlot(slotId) {
    if (confirm("–ë“±–ª —Å–ª–æ—Ç—Ç—ã –∂–æ—é“ì–∞ —Å–µ–Ω—ñ–º–¥—ñ—Å—ñ–∑ –±–µ?")) {
        fetch(`/schedule/delete/${slotId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(data => {
            alert(data.message || "–°–ª–æ—Ç —Å”ô—Ç—Ç—ñ –∂–æ–π—ã–ª–¥—ã!");  // ‚úÖ –°”ô—Ç—Ç—ñ –∂–æ—é —Ç—É—Ä–∞–ª—ã —Ö–∞–±–∞—Ä–ª–∞–º–∞
            location.reload();
        })
        .catch(error => {
            alert("–ñ–æ—é “õ–∞—Ç–µ—Å—ñ: " + error.message);  // ‚úÖ “ö–∞—Ç–µ —Ç—É—Ä–∞–ª—ã —Ö–∞–±–∞—Ä–ª–∞—É
            console.error("–ñ–æ—é “õ–∞—Ç–µ—Å—ñ:", error);
        });
    }
}

function loadDoctorTimes(date) {
    fetch(`/doctor/schedule/times/?date=${date}`)
    .then(response => response.json())
    .then(data => {
        let container = document.getElementById("times-container");
        let errorMessage = document.getElementById("error-message");

        container.innerHTML = "";
        errorMessage.innerText = "";

        if (data.times && data.times.length > 0) {
            data.times.forEach(slot => {
                let slotDiv = document.createElement("div");
                slotDiv.className = "time-slot btn m-1";
                slotDiv.innerHTML = `<span>${slot.start_time}</span>`;

                if (slot.is_booked) {
                    slotDiv.classList.add("btn-warning");  // –ë—Ä–æ–Ω–¥–∞–ª“ì–∞–Ω —Å–ª–æ—Ç
                    slotDiv.innerHTML += `<span class="badge bg-danger">–ë—Ä–æ–Ω–¥–∞–ª“ì–∞–Ω</span>`;
                } else {
                    slotDiv.classList.add("btn-outline-success");
                    slotDiv.innerHTML += `
                        <button class="btn btn-danger btn-sm m-1" onclick="deleteSlot(${slot.id})">‚ùå –ñ–æ—é</button>
                    `;
                }

                container.appendChild(slotDiv);
            });
        } else {
            errorMessage.innerText = "“ö–æ–ª –∂–µ—Ç—ñ–º–¥—ñ —É–∞“õ—ã—Ç—Ç–∞—Ä –∂–æ“õ.";
        }
    })
    .catch(error => {
        console.error("–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ:", error);
        document.getElementById("error-message").innerText = "–î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ –∂“Ø–∫—Ç–µ—É “õ–∞—Ç–µ—Å—ñ.";
    });
}
</script>

<style>
.date-btn {
    min-width: 100px;
    padding: 8px;
    text-align: center;
}
.time-slot {
    min-width: 120px;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    cursor: pointer;
}
</style>
{% endblock %}
